<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Hello 橙子</title>
  <meta name="author" content="John Doe">
  
  <meta name="description" content="我就是故意拼错的">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Hello 橙子"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Hello 橙子</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>Hello 橙子<span class="blink-fast">∎</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart blink-slow"></i>
      好好学习，天天向上.
</div>    
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2018/04/11/FaaS踩坑之fission使用记录/" >FaaS踩坑之fission使用记录</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2018-04-11  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h4 id="1-fission命令"><a href="#1-fission命令" class="headerlink" title="1. fission命令"></a>1. fission命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function, fn                  Create, update and manage functions</span><br><span class="line"></span><br><span class="line">httptrigger, ht, route        Manage HTTP triggers (routes) for functions</span><br><span class="line"></span><br><span class="line">timetrigger, tt, timer        Manage Time triggers (timers) for functions</span><br><span class="line"></span><br><span class="line">mqtrigger, mqt, messagequeue  Manage message queue triggers for functions</span><br><span class="line"></span><br><span class="line">environment, env              Manage environments</span><br><span class="line"></span><br><span class="line">watch, w                      Manage watches</span><br><span class="line"></span><br><span class="line">package, pkg                  Manage packages</span><br><span class="line"></span><br><span class="line">spec, specs                   Manage a declarative app specification</span><br><span class="line"></span><br><span class="line">upgrade                       Upgrade tool from fission v0.1</span><br><span class="line"></span><br><span class="line">tpr2crd                       Migrate tool for TPR to CRD</span><br><span class="line"></span><br><span class="line">help, h                       Shows a list of commands or help for one command</span><br></pre></td></tr></table></figure>
<h4 id="2-使用记录——function"><a href="#2-使用记录——function" class="headerlink" title="2. 使用记录——function"></a>2. 使用记录——function</h4><ol>
<li>已有函数hello.js</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">module.exports = async function(context) &#123;</span><br><span class="line">return &#123;</span><br><span class="line">status: 200,</span><br><span class="line">body: &quot;Hello, world!\n&quot;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>为函数创建route(http请求时用到）：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fission route create --function hello --url /hello</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>创建基于pool executor 的函数</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fission fn create --name hello --code hello.js --env node --executortype poolmgr</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><p>点击函数的url 获得结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://$FISSION_ROUTER/hello</span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>
</li>
<li><p>指定函数最大/最小规模</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fission fn create --name hello --code hello.js --env node --minscale 1 --maxscale 5  --executortype newdeploy</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fission fn update --name hello --code ../hello.js</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fission fn test --name hello</span><br></pre></td></tr></table></figure>
</li>
<li><p>函数运行出错，输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error calling function hello: 500 Internal server error (fission)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看函数运行日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fission fn logs --name hello</span><br></pre></td></tr></table></figure>
</li>
<li><p>building function</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">sourcepkg/</span><br><span class="line">├── __init__.py</span><br><span class="line">├── build.sh</span><br><span class="line">├── requirements.txt</span><br><span class="line">└── user.py</span><br><span class="line"></span><br><span class="line">$ cat user.py</span><br><span class="line">import sys</span><br><span class="line">import yaml</span><br><span class="line"></span><br><span class="line">document = &quot;&quot;&quot;</span><br><span class="line">a: 1</span><br><span class="line">b:</span><br><span class="line">c: 3</span><br><span class="line">d: 4</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">return yaml.dump(yaml.load(document))</span><br><span class="line"></span><br><span class="line">$ cat requirements.txt</span><br><span class="line">pyyaml</span><br><span class="line"></span><br><span class="line">$ cat build.sh</span><br><span class="line">#!/bin/sh</span><br><span class="line">pip3 install -r $&#123;SRC_PKG&#125;/requirements.txt -t $&#123;SRC_PKG&#125; &amp;&amp; cp -r $&#123;SRC_PKG&#125; $&#123;DEPLOY_PKG&#125;</span><br><span class="line">$zip -jr demo-src-pkg.zip sourcepkg/</span><br><span class="line">adding: __init__.py (stored 0%)</span><br><span class="line">adding: build.sh (deflated 24%)</span><br><span class="line">adding: requirements.txt (stored 0%)</span><br><span class="line">adding: user.py (deflated 25%)</span><br><span class="line"></span><br><span class="line">fission fn create --name hellopy --env python --src demo-src-pkg.zip  --entrypoint &quot;user.main&quot; --buildcmd &quot;sh build.sh&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ fission route create --function hellopy --url /hellopy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fission fn update --name hellopy --env python --src demo-src-pkg.zip  --entrypoint &quot;user.main&quot; --buildcmd “sh build.sh”</span><br></pre></td></tr></table></figure>
<p>11.compiled artifacts with Fission</p>
<h4 id="3-使用记录————environment"><a href="#3-使用记录————environment" class="headerlink" title="3 使用记录————environment"></a>3 使用记录————environment</h4><ol>
<li>准备环境<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fission env create --name node --image fission/node-env:0.4.0 --mincpu 40 --maxcpu 80 --minmemory 64 --maxmemory 128 --poolsize 4</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>设置环境，语言镜像，环境中支持几个pre-warmed pod</p>
<ol start="2">
<li><p>在启动环境的时候设置builder</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fission env create --name python --image fission/python-env:latest --builder fission/python-builder:latest</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看env信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fission env list</span><br><span class="line">fission env get --name node</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>使用记录————Controlling Function Execution</p>
<p>安装go<br>安装 hey</p>
<ol>
<li><p>用hey</p>
</li>
<li><p>HorizontalPodAutoscaler</p>
</li>
</ol>
<h4 id="4-使用记录————trigger"><a href="#4-使用记录————trigger" class="headerlink" title="4.使用记录————trigger"></a>4.使用记录————trigger</h4><ol>
<li><p>http trigger：通过http get到一个函数</p>
</li>
<li><p>time trigger：定时执行函数</p>
</li>
<li><p>message queue trigger：基于message queue来执行函数</p>
</li>
</ol>
<p>（NATS and Azure Storage Queue are supported queues.）</p>
<h4 id="5-使用记录————打包"><a href="#5-使用记录————打包" class="headerlink" title="5.使用记录————打包"></a>5.使用记录————打包</h4><ol>
<li><p>打包源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fission package create --sourcearchive demo-src-pkg.zip --env pythonsrc --buildcmd &quot;./build.sh&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>打包deployment</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fission env create --name pythondeploy --image fission/python-env:latest --builder fission/python-builder:latest --mincpu 40 --maxcpu 80 --minmemory 64 --maxmemory 128 --poolsize 2</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="6-使用问题记录："><a href="#6-使用问题记录：" class="headerlink" title="6.使用问题记录："></a>6.使用问题记录：</h4><ol>
<li><p>fission host路径问题，创建环境（go，python,js…），创建executors和函数（创建pod），创建trigger（调用函数）因为第二步和第三步存在依赖关系顺序不能反</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fission env create --name nodejs --image fission/node-env:0.6.0</span><br><span class="line">fission route create --function hello --url /hello</span><br><span class="line">fission fn create --name hello --code hello.js --env nodejs --executortype poolmgr，</span><br></pre></td></tr></table></figure>
</li>
<li><p>fission创建package的时候有权限问题builder不起来，用sh 不用./ 或者用chmod给文件加权限777</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod –R 777 *</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试时 ,需要把$FISSION_ROUTER换了，用的minikube直接换成它的地址，用的k8s换成外部ip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://$FISSION_ROUTER/hello 换成</span><br><span class="line">curl http://35.194.204.59／hello</span><br></pre></td></tr></table></figure>
</li>
<li><p>按照fission命令删除函数以及删除trigger后，发现相关的pod没有被删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fission fn delete --name hellopy</span><br></pre></td></tr></table></figure>
</li>
<li><p>build的路径问题未解决：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error starting cmd: exec: &quot;sh build.sh&quot;: executable file not found in $PATH</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看builder日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k -n fission-builder logs -f py3-4214348-59555d9bd8-ks7m4 builder 换成</span><br><span class="line">kubectl logs python-39799-58b5b4f844-np94r -n fission-builder --container=builder</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 fn,env,ht等时，一个属性赋值错误时：依然被创建会存在，但会使用失败</p>
</li>
<li>测试时的hey 和 k：需要安装go ，hey ，HorizontalPodAutoscaler</li>
<li>创建env时，在这里找镜像:<a href="https://docs.fission.io/0.6.0/concepts/environments/" target="_blank" rel="noopener">https://docs.fission.io/0.6.0/concepts/environments/</a></li>
<li>packge创建失败？感觉builder有问题<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Build timeout due to environment builder not ready</span><br></pre></td></tr></table></figure>
</li>
</ol>

	
	</div>
  <a type="button" href="/2018/04/11/FaaS踩坑之fission使用记录/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2018/04/11/FaaS踩坑之openwhisk文档阅读笔记/" >FaaS踩坑之openwhisk文档阅读笔记</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2018-04-11  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<ul>
<li>FaaS，serverless分布式事件驱动型计算服务，也称为无服务器计算或功能即服务 Function-as-a-Service</li>
<li>计算单元：不是虚拟机，而是一个封装了待执行代码（事件触发）的函数</li>
</ul>
<ul>
<li>yaml：”Yet Another Markup Language”（仍是一种置标语言）</li>
</ul>
<ul>
<li><p>post与get <a href="http://www.w3school.com.cn/tags/html_ref_httpmethods.asp" target="_blank" rel="noopener">http://www.w3school.com.cn/tags/html_ref_httpmethods.asp</a></p>
</li>
<li><p>微服务：一种架构风格，一个大型复杂软件应用由一个或多个微服务组成。系统中的各个微服务可被独立部署，各个微服务之间是松耦合的。每个微服务仅关注于完成一件任务。在所有情况下，每个任务代表着一个小的业务能力。</p>
</li>
<li>反向代理，用于外部网络访问内部网络时使用，正向代理或包过滤方式用于拒绝其他外部访问方式并提供内部网络对外部网络的访问能力。因此可以结合这些方式提供最佳的安全访问方式。</li>
<li>nginx：web服务器</li>
<li><p>Spray：spray is an open-source toolkit for building REST/HTTP-based integration layers on top of Scala and Akka.</p>
</li>
<li><p>Akka：Akka是JAVA虚拟机JVM平台上构建高并发、分布式和容错应用的工具包和运行时。Akka用Scala语言写成，同时提供了Scala和JAVA的开发接口</p>
</li>
<li><p>rest api ：<a href="http://blog.csdn.net/px01ih8/article/details/78674685" target="_blank" rel="noopener">http://blog.csdn.net/px01ih8/article/details/78674685</a></p>
</li>
<li><p>openwhisk：从CouchDB 中的 whisks 数据库装入操作</p>
</li>
<li><p>Scala：一门多范式的编程语言，一种类似java的编程语言，设计初衷是实现可伸缩的语言、并集成面向对象编程和函数式编程的各种特性，Scala 运行在Java虚拟机上，并兼容现有的Java程序。</p>
</li>
</ul>
<ul>
<li><p>Kafka是一种高吞吐量的分布式发布订阅消息系统，它可以处理消费者规模的网站中的所有动作流数据</p>
</li>
<li><p>ActivationId：激活利用特定的标识符来表示远程对象，对象能随着时间被激活。一个激活标识符（类 ActivationID的一个实例）包含了激活一个对象所需的几部分信息：<a href="http://www.oschina.net/uploads/doc/javase-6-doc-api-zh_CN/java/rmi/activation/ActivationID.html" target="_blank" rel="noopener">http://www.oschina.net/uploads/doc/javase-6-doc-api-zh_CN/java/rmi/activation/ActivationID.html</a></p>
</li>
</ul>
<ul>
<li><p>异步调用模型，其中一旦系统接受调用操作的 HTTP 请求后，该请求即会终止</p>
</li>
<li><p>Docker 用于以快速、隔离且受控的方式为我们调用的每个操作设置新的自封装环境（称为容器）。对于每个操作调用，都会衍生一个 Docker 容器，将操作码注入其中</p>
</li>
<li><p>Restful：网络上的所有事物都被抽象为资源，每个资源都有一个唯一的资源标识符，同一个资源具有多种表现形式(xml,json等)，对资源的各种操作不会改变资源标识符，所有的操作都是无状态的</p>
</li>
<li><p>ssl终止：在处理SSL加密/解密的负载均衡器上发生的进程，以便负载均衡器和后端服务器之间的流量处于HTTP中。 后端必须通过限制对负载均衡器的IP的访问来加以保护</p>
</li>
<li><p>Ansible是一个简单的自动化运维管理工具</p>
</li>
<li><p>Cloud Functions 处理流入系统的事件。</p>
</li>
<li><p>触发器在技术上是指某类事件的名称。每个事件属于恰好一个触发器；若用类比说明，触发器类似于基于主题的发布/预订系统中的主题。规则 T -&gt; A 表示“每当来自触发器 T 的事件到达时，通过触发器有效内容调用操作 A。”</p>
</li>
<li><p>订阅源是全部属于某个触发器 T 的事件的流。订阅源通过订阅源操作进行控制，订阅源操作用于处理组成订阅源的事件流的创建、删除、暂停和恢复。通常，订阅源操作通过使用管理通知的 REST API 来与生成事件的外部服务进行交互。</p>
</li>
</ul>

	
	</div>
  <a type="button" href="/2018/04/11/FaaS踩坑之openwhisk文档阅读笔记/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2018/04/11/FaaS踩坑之openwhisk与fission对比/" >FaaS踩坑之openwhisk与fission对比</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2018-04-11  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="实现层面"><a href="#实现层面" class="headerlink" title="实现层面"></a>实现层面</h2><h3 id="fission运行流程"><a href="#fission运行流程" class="headerlink" title="fission运行流程"></a>fission运行流程</h3><p><img src="https://www.kubernetes.org.cn/img/2017/08/20170811193044.jpg" alt="image"></p>
<ol start="0">
<li>controller：对外提供api，通过fission CLI 控制内部组件</li>
<li>router：用户发送http请求请求服务（调用函数）。收到请求，查看缓存（fiction与podurl间的映射）。对于调用过function，router会很快的拿到返回值；没调用过，向 poolmgr 请求一个新的实例。poolmgr 有一个空闲 pods 池，它会选择一个 pod，将函数加载进去（将请求发送到 pod 的容器中），并将 pod 地址返回给 router。</li>
<li>创建环境：对于用户创建的environment，poolmgr中有循环的线程自动在kubernetes中根据env的镜像创建包含三副本pod的deployment，每个pod中有两个container，一个使用env的镜像创建，另一个是fission中的辅助container，镜像是fission/fetcher。两个container共享一个volume。因为env是定义基础镜像，而一个env可能会关联许多function，所以需要fetcher根据具体的function在通用的container里运行不同的code。</li>
<li>poolmgr还会定期清理“不活跃”的deployment，如env。还会定期删除不活跃的pod，让kubernetes自动创建新的、干净的pod供其他function使用。poolmgr提供的API只有两个，一个是根据function获取对应的service url，另一个是类似心跳API帮助维护缓存。因为router里也维护有function到service url的缓存，所以当function被调用时，router会通知poolmgr更新一下对应service对象的时间，避免被误删。</li>
</ol>
<h3 id="openwhisk运行流程"><a href="#openwhisk运行流程" class="headerlink" title="openwhisk运行流程"></a>openwhisk运行流程</h3><p><img src="http://kityminder-img.gz.bcebos.com/fddf5b1af7a3a2de4aebc65b54514d9a203e502f" alt="image"></p>
<ol>
<li>nginx：处理用户发送（如调用函数操作等）将其转发（以及ssl终止）。</li>
<li>contraller：是用户可执行操作（ CRUD请求以及操作调用）的接口。</li>
<li>CouchDB：存储操作（whisk数据库），身份验证（subjects数据库）。</li>
<li>consul：服务发现组件，持续检查系统中可用执行者的运行状态来监视invoker，告诉contraller哪些invoker可用</li>
<li>kafka：contraller和invoker只通过由 Kafka 缓冲和持久存储的消息进行通信。缓冲，减轻内存负担。确保消息不会在系统崩溃时丢失。</li>
<li>invoker：启动Docker执行操作。对于每个操作调用，衍生一个 Docker 容器，将操作码注入。使用传递给代码的参数来执行代码，获取结果，然后销毁该容器</li>
<li>储存结果：存储在CouchDB终端 whisks 数据库中作为 ActivationId 下的激活</li>
</ol>
<h3 id="开发语言"><a href="#开发语言" class="headerlink" title="开发语言"></a>开发语言</h3><h5 id="fission"><a href="#fission" class="headerlink" title="fission"></a>fission</h5><ul>
<li>Go语言</li>
</ul>
<h5 id="openwhisk"><a href="#openwhisk" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>scala语言</li>
</ul>
<h3 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h3><h5 id="fission-1"><a href="#fission-1" class="headerlink" title="fission"></a>fission</h5><ul>
<li>controller</li>
<li>router</li>
<li>executor</li>
<li>kubeWatcher</li>
<li>timer</li>
<li>MessageQueueMgr</li>
<li>storageSvc</li>
<li>builderMgr</li>
</ul>
<h5 id="openwhisk-1"><a href="#openwhisk-1" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>nginx</li>
<li>contraller</li>
<li>CouchDB</li>
<li>consul</li>
<li>kafka</li>
<li>invoker</li>
</ul>
<h2 id="功能层面"><a href="#功能层面" class="headerlink" title="功能层面"></a>功能层面</h2><h3 id="组件-1"><a href="#组件-1" class="headerlink" title="组件"></a>组件</h3><h4 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h4><h5 id="fission-2"><a href="#fission-2" class="headerlink" title="fission"></a>fission</h5><ul>
<li>controller，是fission对外提供管理API的组件。所有其他组件通过关注 controller 来更新负责追踪函数、HTTP 路由、事件触发器和环境镜像</li>
</ul>
<h5 id="openwhisk-2"><a href="#openwhisk-2" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>contraller：是用户可执行操作（如CRUD请求以及操作调用）的接口。</li>
<li>consul：服务发现组件，持续检查系统中可用执行者的运行状态来监视invoker，告诉contraller哪些invoker可用</li>
<li>kafka：一种高吞吐量、分布式的发布/预订消息传递系统。contraller和invoker只通过由 Kafka 缓冲和持久存储的消息进行通信。可以减轻在内存中进行缓冲的负担并降低伴随的 OutOfMemoryException 风险，确保消息不会在系统崩溃时丢失。使用异步调用模型</li>
</ul>
<h4 id="请求响应"><a href="#请求响应" class="headerlink" title="请求响应"></a>请求响应</h4><h5 id="fission-3"><a href="#fission-3" class="headerlink" title="fission"></a>fission</h5><ul>
<li><p>router：收到请求，查看缓存（fiction与podurl间的映射）。对于调用过function，router会很快的拿到返回值；没调用过，向 poolmgr 请求一个新的实例。poolmgr 有一个空闲 pods 池，它会选择一个 pod，将函数加载进去（将请求发送到 pod 的容器中），并将 pod 地址返回给 router。</p>
<h5 id="openwhisk-3"><a href="#openwhisk-3" class="headerlink" title="openwhisk"></a>openwhisk</h5></li>
<li><p>API网关</p>
</li>
</ul>
<h4 id="服务发现组件"><a href="#服务发现组件" class="headerlink" title="服务发现组件"></a>服务发现组件</h4><h5 id="fission-4"><a href="#fission-4" class="headerlink" title="fission"></a>fission</h5><ul>
<li>router，与controller和poolmgr打交道，会监听 controller 中triggers的更新，动态的更新web service的route定义。</li>
<li>poolmgr 负责管理空闲的环境容器池、将函数加载到这些容器当中、以及杀死空闲的函数实例。</li>
</ul>
<h5 id="openwhisk-4"><a href="#openwhisk-4" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>consul：服务发现组件，持续检查系统中可用执行者的运行状态来监视invoker，告诉contraller哪些invoker可用</li>
</ul>
<h4 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h4><h5 id="fission-5"><a href="#fission-5" class="headerlink" title="fission"></a>fission</h5><ul>
<li>Http Trigger</li>
<li>Time Trigger </li>
<li>MQ Trigger </li>
</ul>
<h5 id="openwhisk-5"><a href="#openwhisk-5" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li><p>invoker：启动Docker执行操作，对于每个操作调用，都会衍生一个 Docker 容器，将操作码注入。使用传递给代码的参数来执行代码，获取结果，然后销毁该容器</p>
</li>
<li><p>cloudant</p>
</li>
<li>custom trigger</li>
<li>github</li>
<li>messahub</li>
<li>moblie push</li>
<li>priodic</li>
</ul>
<h4 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h4><h5 id="fission-6"><a href="#fission-6" class="headerlink" title="fission"></a>fission</h5><ul>
<li>etcd</li>
</ul>
<h5 id="openwhisk-6"><a href="#openwhisk-6" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>CouchDB</li>
</ul>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><h4 id="语言支持"><a href="#语言支持" class="headerlink" title="语言支持"></a>语言支持</h4><h5 id="fission-7"><a href="#fission-7" class="headerlink" title="fission"></a>fission</h5><ul>
<li>Binary </li>
<li>Go    </li>
<li>.NET    </li>
<li>.NET 2.0    </li>
<li>NodeJS (Alpine)    </li>
<li>NodeJS (Debian)    </li>
<li>Perl    </li>
<li>PHP 7    </li>
<li>Python 3    </li>
<li>Ruby</li>
</ul>
<h5 id="openwhisk-7"><a href="#openwhisk-7" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>JavaScript</li>
<li>Python</li>
<li>Swift</li>
<li>PhP</li>
<li>Docker</li>
</ul>
<h4 id="函数上传支持"><a href="#函数上传支持" class="headerlink" title="函数上传支持"></a>函数上传支持</h4><h5 id="fission-8"><a href="#fission-8" class="headerlink" title="fission"></a>fission</h5><ul>
<li>环境支持的语言</li>
<li>任何兼容二进制的可执行文件和脚本</li>
</ul>
<h5 id="openwhisk-8"><a href="#openwhisk-8" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>环境支持的语言</li>
<li>Java 方法</li>
<li>任何兼容二进制的可执行文件，包括打包为 Docker 容器的 Go 程序和定制可执行文件</li>
</ul>
<h5 id="源码形式"><a href="#源码形式" class="headerlink" title="源码形式"></a>源码形式</h5><h6 id="云端编译环境"><a href="#云端编译环境" class="headerlink" title="云端编译环境"></a>云端编译环境</h6><p>####### 内容</p>
<p>####### 指令</p>
<h5 id="二进制形式"><a href="#二进制形式" class="headerlink" title="二进制形式"></a>二进制形式</h5><h6 id="本地编译环境要求"><a href="#本地编译环境要求" class="headerlink" title="本地编译环境要求"></a>本地编译环境要求</h6><h4 id="开发方式"><a href="#开发方式" class="headerlink" title="开发方式"></a>开发方式</h4><h5 id="fission-9"><a href="#fission-9" class="headerlink" title="fission"></a>fission</h5><ul>
<li>CLI</li>
</ul>
<h5 id="openwhisk-9"><a href="#openwhisk-9" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>浏览器开发</li>
<li>Cloud Functions CLI</li>
</ul>
<h4 id="启动方式"><a href="#启动方式" class="headerlink" title="启动方式"></a>启动方式</h4><h5 id="fission-10"><a href="#fission-10" class="headerlink" title="fission"></a>fission</h5><ul>
<li>冷启动</li>
</ul>
<h5 id="openwhisk-10"><a href="#openwhisk-10" class="headerlink" title="openwhisk"></a>openwhisk</h5><h4 id="函数操作"><a href="#函数操作" class="headerlink" title="函数操作"></a>函数操作</h4><h5 id="fission-11"><a href="#fission-11" class="headerlink" title="fission"></a>fission</h5><ul>
<li>通过kubectl对pod进行操作</li>
</ul>
<h5 id="openwhisk-11"><a href="#openwhisk-11" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>contraller：是用户可执行操作（如CRUD请求以及操作调用）的接口。</li>
</ul>
<h5 id="打包上传"><a href="#打包上传" class="headerlink" title="打包上传"></a>打包上传</h5><h5 id="调用方式"><a href="#调用方式" class="headerlink" title="调用方式"></a>调用方式</h5><h5 id="fission-12"><a href="#fission-12" class="headerlink" title="fission"></a>fission</h5><ul>
<li>触发器关联</li>
</ul>
<h5 id="openwhisk-12"><a href="#openwhisk-12" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>触发器关联</li>
<li>Cloud Functions API</li>
<li>Cloud Functions CLI</li>
<li>iOS移动SDK</li>
</ul>
<h5 id="执行时间上限"><a href="#执行时间上限" class="headerlink" title="执行时间上限"></a>执行时间上限</h5><h4 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h4><h5 id="fission-13"><a href="#fission-13" class="headerlink" title="fission"></a>fission</h5><ul>
<li>k8s的pod</li>
</ul>
<h5 id="openwhisk-13"><a href="#openwhisk-13" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>docker</li>
</ul>
<h5 id="运行环境的启动"><a href="#运行环境的启动" class="headerlink" title="运行环境的启动"></a>运行环境的启动</h5><h5 id="fission-14"><a href="#fission-14" class="headerlink" title="fission"></a>fission</h5><ul>
<li>Pool-based executor(poolmgr)： </li>
<li>New-deployment executor（newdeploy）：创建一个Kubernetes部署、Service和HorizontalPodAutoscaler</li>
</ul>
<h5 id="openwhisk-14"><a href="#openwhisk-14" class="headerlink" title="openwhisk"></a>openwhisk</h5><h5 id="运行环境的回收"><a href="#运行环境的回收" class="headerlink" title="运行环境的回收"></a>运行环境的回收</h5><h5 id="fission-15"><a href="#fission-15" class="headerlink" title="fission"></a>fission</h5><ul>
<li>poolmgr定期清理“不活跃”的deployment，定期删除不活跃的pod，让kubernetes自动创建新的、干净的pod供其他function使用。（如何定期待查）</li>
</ul>
<h5 id="openwhisk-15"><a href="#openwhisk-15" class="headerlink" title="openwhisk"></a>openwhisk</h5><h4 id="结果返回"><a href="#结果返回" class="headerlink" title="结果返回"></a>结果返回</h4><h5 id="fission-16"><a href="#fission-16" class="headerlink" title="fission"></a>fission</h5><ul>
<li>直接返回</li>
</ul>
<h5 id="openwhisk-16"><a href="#openwhisk-16" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>储存在CouchDB的输出中</li>
</ul>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><h4 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h4><h5 id="fission-17"><a href="#fission-17" class="headerlink" title="fission"></a>fission</h5><h5 id="openwhisk-17"><a href="#openwhisk-17" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>package</li>
<li>包含操作和订阅源</li>
<li>绑定到包指定缺省参数</li>
</ul>
<h4 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h4><h5 id="fission-18"><a href="#fission-18" class="headerlink" title="fission"></a>fission</h5><h5 id="openwhisk-18"><a href="#openwhisk-18" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>CouchDB：在whisk数据库中存储操作，subjects数据库用于身份验证与授权操作并装入操作</li>
</ul>
<h4 id="订阅源支持"><a href="#订阅源支持" class="headerlink" title="订阅源支持"></a>订阅源支持</h4><p>全部属于某个触发器 T 的事件的流</p>
<h5 id="fission-19"><a href="#fission-19" class="headerlink" title="fission"></a>fission</h5><ul>
<li>workflow？</li>
</ul>
<h5 id="openwhisk-19"><a href="#openwhisk-19" class="headerlink" title="openwhisk"></a>openwhisk</h5><p>发布自己的订阅源使用，创建订阅源体系结构：</p>
<ul>
<li>Hook    </li>
<li>轮询</li>
<li>连接</li>
</ul>
<h4 id="自动伸缩"><a href="#自动伸缩" class="headerlink" title="自动伸缩"></a>自动伸缩</h4><h5 id="fission-20"><a href="#fission-20" class="headerlink" title="fission"></a>fission</h5><ul>
<li>自动伸缩</li>
</ul>
<h5 id="openwhisk-20"><a href="#openwhisk-20" class="headerlink" title="openwhisk"></a>openwhisk</h5><h4 id="图形仪表盘"><a href="#图形仪表盘" class="headerlink" title="图形仪表盘"></a>图形仪表盘</h4><h5 id="fission-21"><a href="#fission-21" class="headerlink" title="fission"></a>fission</h5><p>不支持</p>
<h5 id="openwhisk-21"><a href="#openwhisk-21" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>存在。用于监视活动摘要，活动日志，时间线以及过滤选项</li>
</ul>
<h2 id="项目发展现况"><a href="#项目发展现况" class="headerlink" title="项目发展现况"></a>项目发展现况</h2><h3 id="社区发展"><a href="#社区发展" class="headerlink" title="社区发展"></a>社区发展</h3><h5 id="fission-22"><a href="#fission-22" class="headerlink" title="fission"></a>fission</h5><ul>
<li>3.2k star</li>
</ul>
<h5 id="openwhisk-22"><a href="#openwhisk-22" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>3k star</li>
</ul>
<h3 id="使用者"><a href="#使用者" class="headerlink" title="使用者"></a>使用者</h3><h5 id="fission-23"><a href="#fission-23" class="headerlink" title="fission"></a>fission</h5><ul>
<li>Autodesk</li>
<li>cielo24</li>
</ul>
<h5 id="openwhisk-23"><a href="#openwhisk-23" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li><a href="https://www.ibm.com/cloud-computing/bluemix/case-studies" target="_blank" rel="noopener">https://www.ibm.com/cloud-computing/bluemix/case-studies</a></li>
</ul>
<h3 id="支持厂商"><a href="#支持厂商" class="headerlink" title="支持厂商"></a>支持厂商</h3><h5 id="fission-24"><a href="#fission-24" class="headerlink" title="fission"></a>fission</h5><ul>
<li>Platform9</li>
</ul>
<h5 id="openwhisk-24"><a href="#openwhisk-24" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>Apache/IBM</li>
</ul>
<h2 id="底层基础设施对接层面"><a href="#底层基础设施对接层面" class="headerlink" title="底层基础设施对接层面"></a>底层基础设施对接层面</h2><h3 id="组建部署方式"><a href="#组建部署方式" class="headerlink" title="组建部署方式"></a>组建部署方式</h3><h5 id="fission-25"><a href="#fission-25" class="headerlink" title="fission"></a>fission</h5><ul>
<li>通过helm部署在kubernetes上</li>
</ul>
<h5 id="openwhisk-25"><a href="#openwhisk-25" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>通过 Ansible部署在docker中</li>
</ul>
<h3 id="function部署方式"><a href="#function部署方式" class="headerlink" title="function部署方式"></a>function部署方式</h3><h5 id="fission-26"><a href="#fission-26" class="headerlink" title="fission"></a>fission</h5><ul>
<li>以pod形式运行在kubernetes中</li>
</ul>
<h5 id="openwhisk-26"><a href="#openwhisk-26" class="headerlink" title="openwhisk"></a>openwhisk</h5><ul>
<li>运行在docker中</li>
</ul>
<h4 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h4><ul>
<li><a href="https://fission.io" target="_blank" rel="noopener">https://fission.io</a></li>
<li><a href="https://console.bluemix.net/docs/openwhisk/index.html#cloud-functions-" target="_blank" rel="noopener">https://console.bluemix.net/docs/openwhisk/index.html#cloud-functions-</a></li>
<li><a href="https://www.tuicool.com/articles/6NnEb2b" target="_blank" rel="noopener">https://www.tuicool.com/articles/6NnEb2b</a></li>
<li><a href="https://lingxiankong.github.io/2017-03-05-faas-fission.html" target="_blank" rel="noopener">https://lingxiankong.github.io/2017-03-05-faas-fission.html</a></li>
<li><a href="https://www.kubernetes.org.cn/2523.html" target="_blank" rel="noopener">https://www.kubernetes.org.cn/2523.html</a></li>
<li><a href="https://blog.csdn.net/qq_34463875/article/details/60960244" target="_blank" rel="noopener">https://blog.csdn.net/qq_34463875/article/details/60960244</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/opensource/os-introducing-openwhisk-microservices-made-easy/" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/opensource/os-introducing-openwhisk-microservices-made-easy/</a></li>
</ul>

	
	</div>
  <a type="button" href="/2018/04/11/FaaS踩坑之openwhisk与fission对比/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2018/04/10/FaaS踩坑之fission安装/" >FaaS踩坑之fission安装</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2018-04-10  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>上个月申请了sel实验室，来到公司。和丁博士沟通了一下，确定方向是边缘计算中的faas，给我布置了下任务，用一周的时间把fission跑起来，熟悉fission的用法，并比较fission和openwhisk。</p>
<p>fission是跑在k8s上的服务，因此要先申请几个公司的虚拟机做集群，在虚拟机上安装k8s，再安装k8s上的包管理工具helm，最后装fission。安装k8s比较麻烦，丁博士让我不懂就问一个前辈，前辈装过minikube，所以让我从minikube开始。<br>对docker完全真空的我感觉有点懵逼，不过感觉很激动。。就开始啦。</p>
<p>参考 <a href="https://docs.fission.io/0.6.0/installation/installation" target="_blank" rel="noopener">fission官网安装文档</a></p>
<h4 id="0-科学上网"><a href="#0-科学上网" class="headerlink" title="0. 科学上网"></a>0. 科学上网</h4><p>科学上网太重要了。这14天学到各种姿势：</p>
<ol>
<li><p>本地设置http代理在浏览器翻</p>
</li>
<li><p>shadowsocks : 转化socks5协议，可以设置pac自动模式访问墙内网站不走代理。</p>
</li>
<li><p>shadowsocks + privoxy：终端翻，每次运行下面的脚本</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sudo /usr/local/sbin/privoxy /usr/local/etc/privoxy/config</span><br><span class="line"></span><br><span class="line">export http_proxy=&apos;http://localhost:8118&apos;</span><br><span class="line"></span><br><span class="line">export https_proxy=&apos;http://localhost:8118&apos;</span><br><span class="line"></span><br><span class="line">curl www.google.com</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><p>ss + privoxy + proxifier :配置所有应用的流量走ss，可以直接docker  pull 墙外镜像</p>
</li>
<li><p>ssh到虚拟机（比如k8s）一直没实现有些遗憾不然又能跳过一堆坑</p>
</li>
</ol>
<h4 id="1-安装minikube"><a href="#1-安装minikube" class="headerlink" title="1. 安装minikube"></a>1. 安装minikube</h4><p>minikubi是只有一个节点的，可以看成是单机版的k8s，用来编排docker（类似虚拟机，感觉像是运行在镜像上的进程）的工具，可以在minikube上面运行各种跑在docker上的服务（比如fission）。</p>
<p>每一个服务有一个namespace用于防止服务间命名冲突，服务由各种deployment组成，deployment负责启动相关pod，pod可以看成包含很多豆子（docker/image）的豆荚，里面的豆子包括跑着服务的组件和fission里起来的函数。</p>
<p>通过命令行kubectl可以对相关deployment，pod，namespace进行操作如查看或删除等。之后安装fission会经常有pod没起来，用kubectl查看或删除fission重新安装。常用命令有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc --all-namespaces 查看所有服务</span><br><span class="line">kubectl get pods --all-namespaces 查看所有pod</span><br><span class="line">kubectl get ns --all-namespaces  查看所有命名空间</span><br><span class="line">kubectl get secrets --all-namespaces 查看所有secret</span><br><span class="line">kubectl get deployment --all-namespaces   查看deployment</span><br><span class="line">kubectl describe kube-dns-1326421443-19zxq   查看某一pod</span><br><span class="line">kubectl describe pod python-39799-58b5b4f844-zwlc6  -n fission-builder命名空间下查看pod</span><br><span class="line">kubectl describe pods  kube-dns-1326421443-19zxq -n kube-system</span><br><span class="line">kubectl logs python-39799-58b5b4f844-zwlc6 -n fission-builder —container=builder 查看pod 的logs</span><br></pre></td></tr></table></figure>
<p>安装minikube，就是安装一个linux，并在上面安装minikube的相关组件，当所有pod跑起来之后就可以了。<br>参考了其他博客，感觉写的很好，按照博客安装的。<br><a href="https://blog.csdn.net/aixiaoyang168/article/details/78331847?locationNum=6&amp;fps=1" target="_blank" rel="noopener">https://blog.csdn.net/aixiaoyang168/article/details/78331847?locationNum=6&amp;fps=1</a></p>
<p>因为minikube在墙内，安装所需的gcr镜像没有拉下来，通过阿里的镜像库和公司的私有库把镜像docker pull下来传到本机，在本地虚拟机加绝对路径直接docker load进来（感觉非常神奇，不知道本机和本机虚拟机怎么交流的）</p>
<h4 id="或者-1-安装k8s"><a href="#或者-1-安装k8s" class="headerlink" title="或者 1. 安装k8s"></a>或者 1. 安装k8s</h4><p>申请三台虚拟机（4c8g50g)。<br>参考观云台部署文档+脚本一键部署k8s，很快就装好了。<br>然后把k8s的~/.kube/admin.conf传入本机/etc/kubernetes中，让本机连上集群。</p>
<p>坑如下：</p>
<ol>
<li>部署时默认部署单节点集群，还有高可用集群可选（安装时加参数HA）。单节点集群只有一个master不是只有一个节点，高可用集群有多个master。按默认即可差点装错。</li>
<li><p>k8s虚拟机里的DNS服务器能ping通，但是ping其他的网站ping不通。因为公司虚拟机的dns服务器是自己搭建的，什么都解析不了。所以无法用docker pull（因为docker官网都不知道是什么）需要自己添加dns服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/resolv.conf</span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line">/etc/init.d/network restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加了dns服务器好像也不能解析个别地址，比如helm里阿里的repo，所以还要自己添加地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">116.62.99.172 https://aliacs-app-catalog.oss-cn-hangzhou.aliyuncs.com</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="再或者-1-申请谷歌云"><a href="#再或者-1-申请谷歌云" class="headerlink" title="再或者 1. 申请谷歌云"></a>再或者 1. 申请谷歌云</h4><p>在谷歌云上建k8s集群。终端连到谷歌云的集群上。<br>完全无坑，如果只玩fission的话强烈安利，不用拉镜像换repo也没有各种诡异的问题（处理安装helm时多了一步，见安装helm）。但是自己用着玩可以，不能移植到边缘设备如网关，长远看做不成边缘计算的项目。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">启动集群：gcloud container clusters create example-cluster  </span><br><span class="line">关闭集群：gcloud container clusters delete example-cluster</span><br></pre></td></tr></table></figure></p>
<h4 id="2-安装helm"><a href="#2-安装helm" class="headerlink" title="2. 安装helm"></a>2. 安装helm</h4><p>helm是k8s上的包管理工具，可以方便的从repo源（相当于yum源）中的chart（相当于rpm包）安装在k8s。分客户端helm和服务端tiller，分别部署在本地和k8s内部上（也可以客户端也部署在k8s中），版本号要一致。客户端直接下载到本地，服务端通过helm init 自动安装到本机连接的k8s集群中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm init --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.8.7 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br></pre></td></tr></table></figure></p>
<p>安装参考博客：<a href="https://blog.csdn.net/weiguang1017/article/details/78045013" target="_blank" rel="noopener">https://blog.csdn.net/weiguang1017/article/details/78045013</a></p>
<p>需要注意的有：</p>
<ol>
<li>安装helm服务端是依然有个拉不下来的gcr镜像tiller。要么拉下来，要么在helm init时直接指定阿里的镜像进行替换。</li>
<li>helm是从repo上给k8s安装服务，但那个repo也被墙了，helm init时也要指定阿里的repo替换默认repo</li>
<li><p>通过谷歌云安装helm时要先</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount --namespace kube-system tiller</span><br><span class="line">kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span><br><span class="line">kubectl patch deploy --namespace kube-system tiller-deploy -p &apos;&#123;&quot;spec&quot;:&#123;&quot;template&quot;:&#123;&quot;spec&quot;:&#123;&quot;serviceAccount&quot;:&quot;tiller&quot;&#125;&#125;&#125;&#125;&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p>（隐秘的坑，如果被替换的repo地址无法被k8s的dns服务器解析，白替换了）</p>
</li>
</ol>
<h4 id="3-安装fission"><a href="#3-安装fission" class="headerlink" title="3. 安装fission"></a>3. 安装fission</h4><p>安装文档上的一行代码往往运行不了的，看起来就是helm从github上直接直接把fission部署在集群上，但总会出现各种诡异的错误，一开始感觉是完全凭运气安装的，后来发现报错基本可以分成4类：无法下载、什么什么已存在、超时、编译出错<br>解决是这样的</p>
<ol>
<li>把项目直接下载到本地，url变为本地绝对路径（虽然我一直感觉这个问题很奇怪，项目很小又不用翻墙为什么有时候会下不下来）</li>
<li><p>上次安装到一半出错了，这次安装就会报错，要把所有上次的东西删干净，再新建一个ns fission，最好写个shell，每次直接执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">kubectl delete clusterrolebindings fission-builder-crd</span><br><span class="line"></span><br><span class="line">kubectl delete clusterrolebindings fission-fetcher-crd</span><br><span class="line"></span><br><span class="line">kubectl delete clusterrolebindings fission-crd</span><br><span class="line"></span><br><span class="line">kubectl delete ns fission-function</span><br><span class="line"></span><br><span class="line">kubectl delete ns fission-builder</span><br><span class="line"></span><br><span class="line">kubectl delete ns fission</span><br><span class="line"></span><br><span class="line">kubectl delete secrets influxdb -n fission</span><br></pre></td></tr></table></figure>
</li>
<li><p>这个错误只在通过公司脚本安装的k8s上遇到了，因为部署fission需要的镜像没拉下来，应该是k8s拉镜像有问题。于是需要镜像较少的精简版fission-core。<br>先通过fission的源码查到需要镜像 fission/fission-bundle:0.6.0 和  fission/fluentd:0.6.0。拖进去发现还是不行，在谷歌云集群安装了一次fission-core发现上面还跑了一个镜像fission/alpinecurl，load进来把fission跑起来了。记得3个节点都要load，因为fission不一定在哪个节点跑着。</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">传镜像的代码</span><br><span class="line">docker save id(XXX) &gt; XXXXXX.tar</span><br><span class="line">scp XXXXXX.tar root@XX.XX.XX.XX:/images</span><br><span class="line">docker load  XXXXXX.tar</span><br><span class="line">docker images | grep XXX</span><br><span class="line">docker images | more</span><br><span class="line">docker tag  id(XXX) 原名</span><br><span class="line">docker save id(XXX) &gt; XXXXXX.tar</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>安装fission-core有个奇怪的错误，如下，结果是fission源码错误<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">release harping-dragonfly failed: Deployment.apps &quot;router&quot; is invalid: [spec.template.spec.containers[0].livenessProbe.httpGet.port: Invalid value: &quot;8888&quot;: must contain at least one letter or number (a-z, 0-9), spec.template.spec.containers[0].readinessProbe.httpGet.port: Invalid value: &quot;8888&quot;: must contain at least one letter or number (a-z, 0-9)]。</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>。。感觉还是靠运气的。</p>
<h4 id="4-安装fission-ctl"><a href="#4-安装fission-ctl" class="headerlink" title="4. 安装fission ctl"></a>4. 安装fission ctl</h4><p>按文档安装没错的</p>
<h4 id="5-fission使用"><a href="#5-fission使用" class="headerlink" title="5. fission使用"></a>5. fission使用</h4><ol>
<li><p>路径问题：触发函数时curl，FISSION_ROUTER 要换掉，若是minikube安装，直接换成minikube虚拟机地址；若是k8s安装，换成外部ip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://$FISSION_ROUTER/hello 变成 curl http://35.194.204.59／hello</span><br></pre></td></tr></table></figure>
</li>
<li><p>顺序问题：下面的每一步之间有依赖关系，顺序不能颠倒：<br>创建环境（go，python,js…），创建executors和函数（创建pod），创建trigger（调用函数）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fission env create --name nodejs --image fission/node-env:0.6.0</span><br><span class="line">fission fn create --name hello --code hello.js --env nodejs --executortype poolmgr</span><br><span class="line">fission route create --function hello --url /hello</span><br></pre></td></tr></table></figure>
</li>
<li><p>package打包上传问题：</p>
</li>
</ol>
<p>报错：Build timeout due to environment builder not ready ，builder组件有问题</p>
<p>更多关于fission的问题在后面写</p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a href="https://docs.fission.io/0.6.0/installation/installation" target="_blank" rel="noopener">https://docs.fission.io/0.6.0/installation/installation</a><br><a href="http://www.jdon.com/48109" target="_blank" rel="noopener">http://www.jdon.com/48109</a><br><a href="https://www.jianshu.com/p/51a19ef5f8cf" target="_blank" rel="noopener">https://www.jianshu.com/p/51a19ef5f8cf</a><br><a href="https://www.cnblogs.com/Leo_wl/p/6055252.html" target="_blank" rel="noopener">https://www.cnblogs.com/Leo_wl/p/6055252.html</a><br><a href="https://www.kubernetes.org.cn/3096.html" target="_blank" rel="noopener">https://www.kubernetes.org.cn/3096.html</a><br><a href="https://www.kubernetes.org.cn/3280.html" target="_blank" rel="noopener">https://www.kubernetes.org.cn/3280.html</a><br><a href="http://www.dockone.io/article/932" target="_blank" rel="noopener">http://www.dockone.io/article/932</a><br><a href="http://blog.csdn.net/moshenglv/article/details/55806421" target="_blank" rel="noopener">http://blog.csdn.net/moshenglv/article/details/55806421</a><br><a href="http://blog.csdn.net/aixiaoyang168/article/details/78331847?locationNum=6&amp;fps=1" target="_blank" rel="noopener">http://blog.csdn.net/aixiaoyang168/article/details/78331847?locationNum=6&amp;fps=1</a><br><a href="https://blog.csdn.net/weiguang1017/article/details/78045013" target="_blank" rel="noopener">https://blog.csdn.net/weiguang1017/article/details/78045013</a></p>
<p>感谢刘吉安学长虽然不在边缘计算组还每天教我填坑到晚上11点，丁博士教我k8s相关和fission源码分析，崔前辈和高前辈带我入门，没嫌弃我各种弱智的问题。</p>

	
	</div>
  <a type="button" href="/2018/04/10/FaaS踩坑之fission安装/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/FaaS踩坑系列/">FaaS踩坑系列<span>4</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/openwhisk/">openwhisk<span>2</span></a></li>
		
			<li><a href="/tags/Kubernetes/">Kubernetes<span>1</span></a></li>
		
			<li><a href="/tags/minikube/">minikube<span>1</span></a></li>
		
			<li><a href="/tags/fission/">fission<span>3</span></a></li>
		
			<li><a href="/tags/分布式/">分布式<span>1</span></a></li>
		
			<li><a href="/tags/FaaS/">FaaS<span>2</span></a></li>
		
			<li><a href="/tags/helm/">helm<span>1</span></a></li>
		
			<li><a href="/tags/docker/">docker<span>1</span></a></li>
		
			<li><a href="/tags/微服务/">微服务<span>2</span></a></li>
		
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2018/04/11/FaaS踩坑之fission使用记录/" ><i class="fa fa-file-o"></i>FaaS踩坑之fission使用记录</a>
      </li>
    
      <li>
        <a href="/2018/04/11/FaaS踩坑之openwhisk文档阅读笔记/" ><i class="fa fa-file-o"></i>FaaS踩坑之openwhisk文档阅读笔记</a>
      </li>
    
      <li>
        <a href="/2018/04/11/FaaS踩坑之openwhisk与fission对比/" ><i class="fa fa-file-o"></i>FaaS踩坑之openwhisk与fission对比</a>
      </li>
    
      <li>
        <a href="/2018/04/10/FaaS踩坑之fission安装/" ><i class="fa fa-file-o"></i>FaaS踩坑之fission安装</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/0rainge" title="My Github account." target="_blank"]);">My Github</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2018 John Doe
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.    
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
